name: tailor-user

on:
  workflow_dispatch:
    inputs:
      user_id:
        description: Supabase user id
        required: true
      request_id:
        description: job_requests id (UUID)
        required: true

permissions:
  contents: read

# One active tailor per user; newer cancels older
concurrency:
  group: tailor-${{ inputs.user_id }}
  cancel-in-progress: true

env:
  PYTHONPATH: ${{ github.workspace }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  GH_REPO: ${{ github.repository }}
  GH_RUN_ID: ${{ github.run_id }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          test -n "${SUPABASE_URL:-}" || { echo "SUPABASE_URL missing"; exit 1; }
          test -n "${SUPABASE_SERVICE_ROLE_KEY:-}" || { echo "SUPABASE_SERVICE_ROLE_KEY missing"; exit 1; }

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python (with pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install OS tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Python deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt python-docx requests pyyaml beautifulsoup4

      # ---- status: job_requests -> running
      - name: Mark job_requests running
        shell: bash
        run: |
          set -euo pipefail
          curl -sS -m 60 -X PATCH \
            "${SUPABASE_URL%/}/rest/v1/job_requests?id=eq.${{ github.event.inputs.request_id }}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '{"status":"running"}'

      # ---- telemetry: create runs row tied to this GH run
      - name: Create runs row
        id: create_run
        shell: bash
        run: |
          set -euo pipefail
          STARTED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          RUN_PAYLOAD=$(jq -n \
            --arg uid "${{ github.event.inputs.user_id }}" \
            --arg rid "${{ github.event.inputs.request_id }}" \
            --arg wf  "tailor-user" \
            --arg repo "${GH_REPO}" \
            --arg run  "${GH_RUN_ID}" \
            --arg started "$STARTED_AT" \
            '{user_id:$uid,
              request_id:$rid,                     # keep as string (UUID)
              workflow:$wf,
              github_repo:$repo,
              github_run_id: ($run|tonumber),      # numeric
              status:"running",
              started_at:$started}')
          curl -sS -m 60 -X POST \
            "${SUPABASE_URL%/}/rest/v1/runs" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            --data "$RUN_PAYLOAD" \
            | jq -r '.[0].id // empty' > run_id.txt || true
          echo "RUN_ID=$(cat run_id.txt)" >> $GITHUB_ENV

      - name: Fetch user's latest resume
        shell: bash
        run: |
          set -euo pipefail
          python scripts/fetch_user_assets.py --user "${{ github.event.inputs.user_id }}"

      - name: Parse resume -> PATCH profile (skills/contacts)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/parse_resume.py --user "${{ github.event.inputs.user_id }}"

      - name: Crawl boards -> upsert to public.jobs -> data/jobs.jsonl
        shell: bash
        run: |
          set -euo pipefail
          python scripts/crawl.py --user "${{ github.event.inputs.user_id }}"

      - name: Rank jobs -> docs/data/scores.json
        shell: bash
        run: |
          set -euo pipefail
          python scripts/rank.py --user "${{ github.event.inputs.user_id }}"

      - name: Export profile JSON (service role)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/data
          curl -sS -m 60 \
            "${SUPABASE_URL%/}/rest/v1/profiles?id=eq.${{ github.event.inputs.user_id }}&select=*" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -o docs/data/profile.raw.json
          jq '.[0] // {}' docs/data/profile.raw.json > docs/data/profile.json
          rm -f docs/data/profile.raw.json

      - name: Upload shortlist to Storage outputs/<uid>/scores.json
        shell: bash
        run: |
          set -euo pipefail
          OUT_JSON="docs/data/scores.json"
          test -f "$OUT_JSON"
          curl -sS -m 60 -X POST \
            "${SUPABASE_URL%/}/storage/v1/object/outputs/${{ github.event.inputs.user_id }}/scores.json" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "x-upsert: true" \
            --data-binary @"$OUT_JSON"

      - name: Upload profile to Storage outputs/<uid>/profile.json
        shell: bash
        run: |
          set -euo pipefail
          PROF_JSON="docs/data/profile.json"
          test -f "$PROF_JSON"
          curl -sS -m 60 -X POST \
            "${SUPABASE_URL%/}/storage/v1/object/outputs/${{ github.event.inputs.user_id }}/profile.json" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "x-upsert: true" \
            --data-binary @"$PROF_JSON"

      - name: Upload run artifacts metadata (scores.json)
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -s docs/data/scores.json ]; then
            KEY="outputs/${{ github.event.inputs.user_id }}/scores.json"
            BYTES=$(wc -c < docs/data/scores.json | tr -d ' ')
            PAYLOAD=$(jq -n \
              --arg uid "${{ github.event.inputs.user_id }}" \
              --arg rid "${RUN_ID:-}" \
              --arg kind "scores" \
              --arg key  "$KEY" \
              --arg path "docs/data/scores.json" \
              --argjson bytes $BYTES \
              '{user_id:$uid,
                run_id: ( ($rid // "") | if length>0 then (try (.|tonumber) catch null) else null end ),
                kind:$kind, storage_key:$key, path_hint:$path, bytes:$bytes}')
            curl -sS -m 60 -X POST \
              "${SUPABASE_URL%/}/rest/v1/artifacts" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Content-Type: application/json" \
              --data "$PAYLOAD" >/dev/null || true
          fi

      - name: Mark job_requests done + runs done
        if: ${{ success() }}
        shell: bash
        run: |
          set -euo pipefail
          curl -sS -m 60 -X PATCH \
            "${SUPABASE_URL%/}/rest/v1/job_requests?id=eq.${{ github.event.inputs.request_id }}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '{"status":"done"}'
          curl -sS -m 60 -X PATCH \
            "${SUPABASE_URL%/}/rest/v1/runs?github_run_id=eq.${{ env.GH_RUN_ID }}&workflow=eq.tailor-user" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '{"status":"done","finished_at":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}'

      - name: Mark job_requests error + runs error
        if: ${{ failure() }}
        shell: bash
        run: |
          set -euo pipefail
          MSG=$(jq -n --arg m "worker failed; check GH logs" '{"status":"error","message":$m}')
          curl -sS -m 60 -X PATCH \
            "${SUPABASE_URL%/}/rest/v1/job_requests?id=eq.${{ github.event.inputs.request_id }}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data "$MSG"
          curl -sS -m 60 -X PATCH \
            "${SUPABASE_URL%/}/rest/v1/runs?github_run_id=eq.${{ env.GH_RUN_ID }}&workflow=eq.tailor-user" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '{"status":"error","finished_at":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'","message":"failed"}'
