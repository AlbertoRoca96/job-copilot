<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>job-copilot — Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <main id="main" class="wrap" role="main" aria-labelledby="page-title">
    <h1 id="page-title">Feedback</h1>
    <p class="muted">Found a bug? Have an idea or question? Please avoid including sensitive information.</p>

    <!-- Keep this attribute so screenshots exclude the form UI by default -->
    <form class="card" data-no-screenshot novalidate aria-describedby="form-help">
      <p id="form-help" class="help">All fields are optional except “Message”.</p>

      <label for="fbType">Type</label>
      <select id="fbType" name="type">
        <option value="bug">Bug</option>
        <option value="suggestion">Suggestion</option>
        <option value="question">Question</option>
        <option value="praise">Praise</option>
      </select>

      <label for="fbSubject">Subject (optional)</label>
      <input id="fbSubject" name="subject" type="text" placeholder="Short summary" />

      <label for="fbMessage">Message <span class="sr-only">(required)</span></label>
      <textarea id="fbMessage" name="message" rows="8" placeholder="Describe the issue or idea…" aria-required="true"></textarea>

      <label for="fbEmail">Email (optional, for follow-up)</label>
      <input id="fbEmail" name="email" type="email" placeholder="you@example.com" autocomplete="email" />

      <fieldset>
        <legend>Extras</legend>
        <label class="muted"><input type="checkbox" id="shot" checked aria-describedby="shot-h"> Include screenshot</label>
        <div id="shot-h" class="sr-only">Includes a screenshot of the current page except elements marked “no screenshot”.</div>
        <label class="muted"><input type="checkbox" id="logs" checked> Include console errors</label>
        <label class="muted"><input type="checkbox" id="sev"> Mark as high severity</label>
      </fieldset>

      <label for="fbSteps">Steps to reproduce (optional)</label>
      <textarea id="fbSteps" name="steps" rows="4" placeholder="1) ... 2) ... 3) ..."></textarea>

      <div class="row" style="margin-top:10px">
        <button id="send" class="btn primary" type="button">Send</button>
        <div id="status" class="status" role="status" aria-live="polite"></div>
      </div>
    </form>

    <p style="margin-top:16px"><a href="./" aria-label="Back to start">← Back to start</a></p>
  </main>

  <!-- Supabase config -->
  <script>
    window.SUPABASE_URL = "https://imozfqawxpsasjdmgdkh.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltb3pmcWF3eHBzYXNqZG1nZGtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Njk3NTUsImV4cCI6MjA3NDE0NTc1NX0.fkGObZvEy-oUfLrPcwgTSJbc-n6O5aE31SGIBeXImtc";
  </script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // Page version of feedback widget (a11y + improved logging + screenshot exclusions)
    window.addEventListener('load', async () => {
      const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      const $ = id => document.getElementById(id);
      const status = $('status');

      function setBusy(b){ status.setAttribute('aria-busy', b ? 'true':'false'); }

      // Collect console errors/warnings + window errors (kept in-memory; sampled on submit)
      const LOGS = [];
      (function setupLogCapture(){
        const push = (level, msg, extra={}) => {
          try { LOGS.push({ t: Date.now(), level, msg: String(msg).slice(0, 2000), ...extra }); }
          catch {}
        };
        const origError = console.error.bind(console);
        const origWarn  = console.warn.bind(console);
        console.error = (...args) => { push('error', args.map(a=>String(a)).join(' ')); origError(...args); };
        console.warn  = (...args) => { push('warn',  args.map(a=>String(a)).join(' ')); origWarn(...args); };
        window.addEventListener('error', (e) => push('error', e.message, {source:e.filename, line:e.lineno, col:e.colno}));
        window.addEventListener('unhandledrejection', (e) => push('error', 'unhandledrejection: ' + String(e.reason || '')));
      })();

      async function screenshot() {
        try {
          const canvas = await html2canvas(document.body, { ignoreElements: n => n.closest?.('[data-no-screenshot]') });
          return canvas.toDataURL('image/png', 0.92);
        } catch { return null; }
      }

      $('send').addEventListener('click', async () => {
        const message = $('fbMessage').value.trim();
        if (!message) {
          status.innerHTML = '<span class="error" role="alert">Please enter a message.</span>';
          return;
        }
        setBusy(true);
        status.textContent = 'Sending…';
        try {
          const payload = {
            type: $('fbType').value,
            subject: $('fbSubject').value.trim() || undefined,
            message,
            email: $('fbEmail').value.trim() || undefined,
            page: document.querySelector('h1')?.textContent?.trim(),
            url: location.href,
            user_agent: navigator.userAgent,
            severity: $('sev').checked ? 'high' : undefined,
            steps: $('fbSteps').value.trim() || undefined,
            console: $('logs').checked ? LOGS.slice(-50) : undefined,
            screenshot_data_url: $('shot').checked ? (await screenshot()) : null,
          };
          const { data, error } = await supabase.functions.invoke('feedback-submit', { body: payload });
          status.textContent = error ? ('Error: ' + (error.message || 'failed')) : ('Thanks! Feedback ID: ' + (data?.id || 'sent'));
        } catch (e) {
          status.innerHTML = '<span class="error" role="alert">Error: '+ (e?.message || e) +'</span>';
        } finally { setBusy(false); }
      });
    });
  </script>

  <!-- Voice assistant (site-wide) -->
  <script defer src="js/voice-assistant.js?v=2025-10-24"></script>
</body>
</html>
